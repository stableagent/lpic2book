### **204.3 مدیریت حجم منطقی (LVM)**

**وزن:** 3

**توضیحات:** داوطلبان باید بتوانند volumeهای منطقی، گروه‌های volume و volumeهای فیزیکی را ایجاد و حذف کنند. این هدف شامل snapshotها و تغییر اندازه volumeهای منطقی است.

**نواحی کلیدی دانش:**

* ابزارها در مجموعه LVM
* تغییر اندازه، تغییر نام، ایجاد و حذف volumeهای منطقی، گروه‌های volume و volumeهای فیزیکی
* ایجاد و نگهداری snapshotها
* فعال کردن گروه‌های volume

**اصطلاحات و ابزارها:**

* /sbin/pv*
* /sbin/lv*
* /sbin/vg*
* mount
* /dev/mapper/
* lvm.conf

### LVM

در مدیریت ذخیره‌سازی سنتی، سیستم عامل به دنبال درایوهای دیسک مانند /dev/sda، /dev/sdb می‌گردد و سپس به دنبال این نگاه می‌کند چه پارتیشن‌هایی روی دیسک‌ها موجود هستند مانند /dev/sda1، /dev/sdb1. پارتیشن‌ها محدود به دیسک‌ها هستند و بسیار انعطاف‌پذیر نیستند. مدیریت حجم منطقی (LVM) با ایجاد یک لایه انتزاع بین سیستم عامل و دستگاه‌های دیسک، انعطاف‌پذیری را به ما می‌دهد.

LVM با قرار دادن لایه‌های abstractions روی بالای دستگاه‌های ذخیره‌سازی فیزیکی کار می‌کند، لایه‌های اساسی که LVM استفاده می‌کند به شرح زیر است:

![](/assets/LVM.jpg)

* volumeهای فیزیکی (pv): یک volume فیزیکی معمولاً یک هارد دیسک است، با این حال ممکن است دستگاهی باشد که شبیه یک هارد دیسک به نظر می‌رسد (مثلاً: دستگاه raid نرم‌افزاری). این می‌تواند یک پارتیشن یا تمام دیسک باشد.

* گروه‌های volume (vg): گروه volume سطح مرکزی و قلب LVM است. این یک مجموعه از volumeهای فیزیکی را جمع می‌کند و یک استخر از منابع ذخیره‌سازی متفاوت ایجاد می‌کند.

* volumeهای منطقی (lv): معادل یک پارتیشن دیسک در یک سیستم غیر LVM است. volume منطقی فضای دیسک را از فضای دیسک که روی گروه volume در دسترس است می‌گیرد. روی بالای volumeهای منطقی ما سیستم‌های فایل (xfs، ext4، ...) ایجاد می‌کنیم

LVM قادر است عملیاتی مانند افزایش و کاهش اندازه یک volume منطقی (که بعداً در مورد آن صحبت خواهیم کرد) انجام دهد زیرا volume فیزیکی از قطعات کوچک که همیشه اندازه ثابت دارند ساخته شده است. هر دیسک فیزیکی که ترکیبی در ساخت یک گروه volume می‌کند، تعداد زیادی از قطعات کوچک با اندازه مساوی خواهد داشت، که داده در آنجا سکونت می‌یابد.

![](/assets/LVMPELE.jpg)

این قطعات کوچک با اندازه مساوی که volumeهای فیزیکی را تشکیل می‌دهند به عنوان Physical Extents شناخته می‌شوند. ایجاد یک گروه volume به سادگی تمام physical extents تمام volumeهای فیزیکی را ترکیب می‌کند تا یک گروه volume منطقی بزرگ شکل دهد.

سیستم‌های مبتنی بر Red Hat به طور پیش‌فرض از LVM استفاده می‌کنند، آن‌ها LVM را در طول نصب setup می‌کنند، بنابراین اینجا ما از Ubuntu برای ایجاد LVM استفاده می‌کنیم:

```
root@server2:~# apt-get install lvm2
```

#### کار با volumeهای فیزیکی (pv)

اینجا ما از sdb، sdc برای ایجاد pv استفاده می‌کنیم. برای آماده کردن یک پارتیشن تا یک volume فیزیکی در LVM باشد، توصیه می‌شود آن را با برچسب LVM فرمت کنیم:

```
root@server2:~# ls -l /dev/sd*
brw-rw---- 1 root disk 8,  0 Jan 13 21:55 /dev/sda
brw-rw---- 1 root disk 8,  1 Jan 13 21:55 /dev/sda1
brw-rw---- 1 root disk 8,  2 Jan 13 21:55 /dev/sda2
brw-rw---- 1 root disk 8,  5 Jan 13 21:55 /dev/sda5
brw-rw---- 1 root disk 8, 16 Jan 13 22:02 /dev/sdb
brw-rw---- 1 root disk 8, 32 Jan 13 22:02 /dev/sdc

root@server2:~# fdisk /dev/sdb 

Welcome to fdisk (util-linux 2.27.1).
Changes will remain in memory only, until you decide to write them.
Be careful before using the write command.


Command (m for help): n
Partition type
   p   primary (0 primary, 0 extended, 4 free)
   e   extended (container for logical partitions)
Select (default p): p
Partition number (1-4, default 1): 
First sector (2048-2097151, default 2048): 
Last sector, +sectors or +size{K,M,G,T,P} (2048-2097151, default 2097151): 

Created a new partition 1 of type 'Linux' and of size 1023 MiB.

Command (m for help): t
Selected partition 1
Partition type (type L to list all types): L

 0  Empty           24  NEC DOS         81  Minix / old Lin bf  Solaris        
 1  FAT12           27  Hidden NTFS Win 82  Linux swap / So c1  DRDOS/sec (FAT-
 2  XENIX root      39  Plan 9          83  Linux           c4  DRDOS/sec (FAT-
 3  XENIX usr       3c  PartitionMagic  84  OS/2 hidden or  c6  DRDOS/sec (FAT-
 4  FAT16 <32M      40  Venix 80286     85  Linux extended  c7  Syrinx         
 5  Extended        41  PPC PReP Boot   86  NTFS volume set da  Non-FS data    
 6  FAT16           42  SFS             87  NTFS volume set db  CP/M / CTOS / .
 7  HPFS/NTFS/exFAT 4d  QNX4.x          88  Linux plaintext de  Dell Utility   
 8  AIX             4e  QNX4.x 2nd part 8e  Linux LVM       df  BootIt         
 9  AIX bootable    4f  QNX4.x 3rd part 93  Amoeba          e1  DOS access     
 a  OS/2 Boot Manag 50  OnTrack DM      94  Amoeba BBT      e3  DOS R/O        
 b  W95 FAT32       51  OnTrack DM6 Aux 9f  BSD/OS          e4  SpeedStor      
 c  W95 FAT32 (LBA) 52  CP/M            a0  IBM Thinkpad hi ea  Rufus alignment
 e  W95 FAT16 (LBA) 53  OnTrack DM6 Aux a5  FreeBSD         eb  BeOS fs        
 f  W95 Ext'd (LBA) 54  OnTrackDM6      a6  OpenBSD         ee  GPT            
10  OPUS            55  EZ-Drive        a7  NeXTSTEP        ef  EFI (FAT-12/16/
11  Hidden FAT12    56  Golden Bow      a8  Darwin UFS      f0  Linux/PA-RISC b
```

وقتی فهرست را با موفقیت ایجاد کردیم، باید نوع پارتیشن را به "Linux LVM" تغییر دهیم. نوع پارتیشن "Linux LVM" دارای کد شناسایی 8e است.

```
Command (m for help): 8e
Selected partition 1
Partition type is changed to 'Linux LVM'

Command (m for help): w
The partition table has been altered!
```

اکنون پارتیشن را به عنوان volume فیزیکی (PV) ایجاد می‌کنیم:

```
root@server2:~# pvcreate /dev/sdb1
  Physical volume "/dev/sdb1" successfully created

root@server2:~# pvcreate /dev/sdc1
  Physical volume "/dev/sdc1" successfully created
```

برای تأیید اینکه آن‌ها درست ایجاد شده‌اند، می‌توانیم از دستور `pvs` استفاده کنیم:

```
root@server2:~# pvs
  PV         VG   Fmt  Attr PSize   PFree 
  /dev/sdb1       lvm2 ---  1023.00m 1023.00m
  /dev/sdc1       lvm2 ---  1023.00m 1023.00m
```

همچنین می‌توانیم از `pvdisplay` برای اطلاعات بیشتر استفاده کنیم:

```
root@server2:~# pvdisplay
  "/dev/sdb1" is a new physical volume of "1023.00 MiB"
  --- NEW Physical volume ---
  PV Name               /dev/sdb1
  VG Name               
  PV Size               1023.00 MiB
  Allocatable           NO
  PE Size (KByte)       0   
  Total PE              0
  Free PE               0
  Allocated PE          0
  PV UUID               qAjXIE-2D4p-3c1U-OwEe-Wt1T-c3dD-Vg7D9N

  "/dev/sdc1" is a new physical volume of "1023.00 MiB"
  --- NEW Physical volume ---
  PV Name               /dev/sdc1
  VG Name               
  PV Size               1023.00 MiB
  Allocatable           NO
  PE Size (KByte)       0   
  Total PE              0
  Free PE               0
  Allocated PE          0
  PV UUID               3nG5fF-vq5V-1m6s-E4nJ-9f1U-3gKj-9D5s8Q
```

#### کار با گروه‌های volume (vg)

حالا باید volumeهای فیزیکی را در یک گروه volume ترکیب کنیم:

```
root@server2:~# vgcreate my_vg /dev/sdb1 /dev/sdc1
  Volume group "my_vg" successfully created
```

برای تأیید اینکه گروه volume درست ایجاد شده است:

```
root@server2:~# vgs
  VG    #PV #LV #SN Attr   VSize   VFree 
  my_vg   2   0   0 wz--n-   1.99g   1.99g
```

همچنین می‌توانیم از `vgdisplay` برای اطلاعات بیشتر استفاده کنیم:

```
root@server2:~# vgdisplay
  --- Volume group ---
  VG Name               my_vg
  System ID             
  Format                lvm2
  Metadata Areas        2
  Metadata Sequence No  1
  VG Access             read/write
  VG Status             resizable
  MAX LV                0
  Cur LV                0
  Open LV               0
  Max PV                0
  Cur PV                2
  Act PV                2
  VG Size               1.99 GiB
  PE Size (KByte)       4.00
  Total PE              509
  Alloc PE / Size       0 / 0   
  Free  PE / Size       509 / 1.99 GiB
  VG UUID               3k9h8U-5t2s-9m1n-2p4q-8r7s-9t0u-1v2w3x
```

#### کار با volumeهای منطقی (lv)

حالا می‌توانیم volumeهای منطقی را در گروه volume ایجاد کنیم:

```
root@server2:~# lvcreate -L 500M -n my_lv my_vg
  Logical volume "my_lv" created.
```

یا می‌توانیم از درصد استفاده کنیم:

```
root@server2:~# lvcreate -l 25%VG -n my_lv2 my_vg
  Logical volume "my_lv2" created.
```

برای تأیید:

```
root@server2:~# lvs
  LV     VG    Attr       LSize   Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
  my_lv  my_vg -wi-a----- 500.00m                                                    
  my_lv2 my_vg -wi-a----- 509.00m
```

همچنین می‌توانیم از `lvdisplay` استفاده کنیم:

```
root@server2:~# lvdisplay
  --- Logical volume ---
  LV Path                /dev/my_vg/my_lv
  LV Name                my_lv
  VG Name                my_vg
  LV UUID                1k2m3n-4p5q-6r7s-8t9u-0v1w-2x3y-4z5a
  LV Write Access        read/write
  LV Creation host, time server2, 2018-01-13 22:30:00 +0000
  LV Status              available
  # open                 0
  LV Size                500.00 MiB
  Current LE             125
  Segments               1
  Allocation             inherit
  Read ahead sectors     auto
  - currently set to     256
  Block device           252:0
```

#### ایجاد فایل‌سیستم و mount کردن

حالا می‌توانیم فایل‌سیستم روی volume منطقی ایجاد کنیم:

```
root@server2:~# mkfs.ext4 /dev/my_vg/my_lv
mke2fs 1.42.13 (18-May-2015)
Filesystem label=
OS type: Linux
Block size=1024 (log=0)
Fragment size=1024 (log=0)
Stride=0 blocks, Stripe width=0 blocks
128000 inodes, 512000 blocks
25600 blocks (5.00%) reserved for the super user
First data block=1
Maximum filesystem blocks=67633152
64 block groups
8192 blocks per group, 8192 fragments per group
2000 inodes per group
Filesystem UUID: 12345678-1234-1234-1234-123456789abc
Superblock backups stored on blocks: 
    8193, 16385, 24577, 32769, 40961, 49153, 57345, 65537, 73729, 81921, 90113, 98305, 106497, 114689, 122881, 131073, 139265, 147457, 155649, 163841, 172033, 180225, 188417, 196609, 204801, 212993, 221185, 229377, 237569, 245761, 253953, 262145, 270337, 278529, 286721, 294913, 303105, 311297, 319489, 327681, 335873, 344065, 352257, 360449, 368641, 376833, 385025, 393217, 401409, 409601

Allocating group tables: done                            
Writing inode tables: done                            
Creating journal (4096 blocks): done
Writing superblocks and filesystem accounting information: done
```

حالا بیایید mount کنیم:

```
root@server2:~# mkdir /mnt/lvm_test
root@server2:~# mount /dev/my_vg/my_lv /mnt/lvm_test/
root@server2:~# df -h /mnt/lvm_test/
Filesystem            Size  Used Avail Use% Mounted on
/dev/mapper/my_vg-my_lv  485M  1.6M  455M   1% /mnt/lvm_test
```

#### تغییر اندازه volumeهای منطقی

افزایش اندازه volume منطقی:

```
root@server2:~# lvextend -L +500M /dev/my_vg/my_lv
  Size of logical volume my_vg/my_lv changed from 500.00 MiB (125 extents) to 1000.00 MiB (250 extents).
  Logical volume my_vg/my_lv successfully resized.
```

سپس فایل‌سیستم را تغییر اندازه می‌دهیم:

```
root@server2:~# resize2fs /dev/my_vg/my_lv
resize2fs 1.42.13 (18-May-2015)
Filesystem at /dev/my_vg/my_lv is mounted on /mnt/lvm_test; on-line resizing required
old_desc_blocks = 4, new_desc_blocks = 8
Performing an on-line resize of /dev/my_vg/my_lv to 1024000 (4k) blocks.
The filesystem on /dev/my_vg/my_lv is now 1024000 blocks long.
```

کاهش اندازه volume منطقی (ابتدا فایل‌سیستم را unmount کنید):

```
root@server2:~# umount /mnt/lvm_test/
root@server2:~# resize2fs /dev/my_vg/my_lv 500M
resize2fs 1.42.13 (18-May-2015)
Please run 'e2fsck -f /dev/my_vg/my_lv' first.

root@server2:~# e2fsck -f /dev/my_vg/my_lv
e2fsck 1.42.13 (18-May-2015)
Pass 1: Checking inodes, blocks, and sizes
Pass 2: Checking directory structure
Pass 3: Checking directory connectivity
Pass 4: Checking reference counts
Pass 5: Checking group summary information
/dev/my_vg/my_lv: 11/128000 files (0.0% non-contiguous), 26512/512000 blocks

root@server2:~# resize2fs /dev/my_vg/my_lv 500M
resize2fs 1.42.13 (18-May-2015)
Resizing the filesystem on /dev/my_vg/my_lv to 512000 (4k) blocks.
The filesystem on /dev/my_vg/my_lv is now 512000 blocks long.

root@server2:~# lvreduce -L 500M /dev/my_vg/my_lv
  WARNING: Reducing active logical volume to 500.00 MiB.
  THIS MAY DESTROY YOUR DATA (filesystem etc.)
Do you really want to reduce my_vg/my_lv? [y/N]: y
  Size of logical volume my_vg/my_lv changed from 1000.00 MiB (250 extents) to 500.00 MiB (125 extents).
  Logical volume my_vg/my_lv successfully resized.
```

#### کار با snapshotها

ایجاد snapshot:

```
root@server2:~# lvcreate -s -L 100M -n my_lv_snap /dev/my_vg/my_lv
  Logical volume "my_lv_snap" created.
```

حذف snapshot:

```
root@server2:~# lvremove /dev/my_vg/my_lv_sv
Do you really want to remove active logical volume my_vg/my_lv_snap? [y/N]: y
  Logical volume "my_vg/my_lv_snap" successfully removed
```

#### خلاصه

LVM ابزار قدرتمندی برای مدیریت ذخیره‌سازی در لینوکس است که انعطاف‌پذیری زیادی را برای مدیران سیستم فراهم می‌کند. با درک مفاهیم PV، VG، LV و کار با ابزارهای LVM، می‌توانید به راحتی ذخیره‌سازی سیستم خود را مدیریت کنید.
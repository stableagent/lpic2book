### **202.2 بازیابی سیستم**

**وزن:** 4

**توضیحات:** داوطلبان باید بتوانند در طول فرآیند بوت و در حالت بازیابی به درستی با سیستم لینوکس کار کنند. این هدف شامل استفاده از هر دو ابزار init و گزینه‌های مرتبط با کرنل init است. داوطلبان باید بتوانند علت خطاها در بارگذاری و استفاده از bootloaderها را تعیین کنند. GRUB نسخه 2 و GRUB Legacy bootloaderهای مورد علاقه هستند. سیستم‌های BIOS و UEFI پوشش داده می‌شوند.

**نواحی کلیدی دانش:**

* BIOS و UEFI
* NVMe بوت
* GRUB نسخه 2 و Legacy
* grub shell
* شروع bootloader و تحویل به کرنل
* بارگیری کرنل
* راه‌اندازی اولیه و تنظیم سخت‌افزار
* راه‌اندازی اولیه و تنظیم daemon/service
* دانستن مکان‌های نصب bootloader مختلف روی دیسک سخت یا دستگاه قابل جابجایی
* بازنویسی گزینه‌های استاندارد bootloader و استفاده از shellهای bootloader
* استفاده از حالت‌های rescue و emergency systemd

**اصطلاحات و ابزارها:**

* mount
* fsck
* inittab, telinit و init با SysV init
* محتوای /boot/, /boot/grub/ و /boot/efi/
* EFI System Partition (ESP)
* GRUB
* grub-install
* efibootmgr
* UEFI shell
* initrd, initramfs
* Master boot record
* systemctl

#### نمای کلی فرآیند بوت

بیایید نگاهی به فرآیند بوت بیندازیم و هر آنچه تا کنون آموخته‌ایم را تثبیت کنیم:

```
BIOS / UEFI
    |
    Bootable Disk
        |
        Boot Loader(LILO,Grub,Grub2)
            |
            Kernel (initramfs/initd)
                |
                init --->systemd / upstart / SysV
                            |
                            system services
                                        |
                                        user space
```

### BIOS

BIOS (Basic Input/Output System) سیستم اولیه‌ای است که کامپیوتر شما را روشن می‌کند. وقتی کامپیوتر روشن می‌شود، BIOS فرآیند POST (Power-On Self Test) را اجرا می‌کند و سپس به دنبال یک دستگاه بوت قابل بوت می‌گردد.

### UEFI

UEFI (Unified Extensible Firmware Interface) جایگزین مدرن BIOS است. UEFI امکانات بیشتری مانند:

* رابط گرافیکی
* پشتیبانی از دیسک‌های بزرگ‌تر از 2TB
* بوت ایمن (Secure Boot)
* راه‌اندازی سریع‌تر

### GRUB

GRUB (GRand Unified Bootloader) bootloader محبوب لینوکس است که در دو نسخه موجود است:

* **GRUB Legacy**: نسخه قدیمی‌تر
* **GRUB 2**: نسخه جدیدتر که در اکثر توزیع‌های مدرن استفاده می‌شود

### فایل‌های مهم بوت

* `/boot/grub/grub.cfg`: فایل پیکربندی GRUB 2
* `/etc/default/grub`: فایل پیکربندی پیش‌فرض GRUB
* `/boot/initramfs-*.img`: تصویر initramfs
* `/boot/vmlinuz-*: کرنل لینوکس

### بازیابی سیستم

#### استفاده از حالت rescue systemd

برای ورود به حالت rescue:

```
systemctl rescue
```

یا

```
systemctl emergency
```

#### بازیابی با استفاده از initramfs

اگر سیستم شما نمی‌تواند بوت شود، ممکن است بتوانید با initramfs مشکل را حل کنید:

```
# در خط فرمان GRUB
linux /vmlinuz root=/dev/sda1 init=/bin/bash
```

#### بررسی فایل‌سیستم

برای بررسی فایل‌سیستم:

```
fsck /dev/sda1
```

#### نصب مجدد GRUB

برای نصب مجدد GRUB:

```
# برای BIOS
grub-install /dev/sda

# برای UEFI
grub-install --target=x86_64-efi --efi-directory=/boot/efi
```

#### تغییر root filesystem

اگر نیاز به تغییر root filesystem دارید:

```
mount /dev/sda1 /mnt
mount --bind /dev /mnt/dev
mount --bind /proc /mnt/proc
mount --bind /sys /mnt/sys
chroot /mnt
```

#### بازیابی رمز عبور root

برای بازیابی رمز عبور root:

1. در GRUB، کرنل را با init=/bin/bash بوت کنید
2. پس از بوت شدن، رمز عبور root را تغییر دهید:
   ```
   passwd root
   ```

#### مشکلات رایج بوت

**مشکل: Kernel Panic**
* بررسی کنید که فایل initramfs صحیح باشد
* بررسی کنید که device mapping صحیح باشد

**مشکل: Root filesystem not found**
* بررسی کنید که UUID صحیح باشد
* بررسی کنید که فایل /etc/fstab صحیح باشد

**مشکل: GRUB error**
* بازتولید فایل پیکربندی GRUB
* نصب مجدد GRUB

#### ابزارهای مفید بازیابی

* **systemd-analyze**: تحلیل زمان بوت
* **journalctl**: مشاهده لاگ‌های سیستم
* **dmesg**: مشاهده پیام‌های کرنل
* **lsblk**: لیست کردن دستگاه‌های بلوکی

#### نکات امنیتی

* همیشه قبل از انجام تغییرات مهم، بکاپ بگیرید
* از دستورات بازیابی با دقت استفاده کنید
* اطمینان حاصل کنید که تغییرات شما درست هستند

#### خلاصه

بازیابی سیستم مهارت مهمی برای هر مدیر سیستم لینوکس است. با درک فرآیند بوت و ابزارهای موجود، می‌توانید اکثر مشکلات بوت را حل کنید. مهم است که با محیط‌های مختلف (BIOS/UEFI) و bootloaderهای مختلف آشنا باشید و بدانید چه زمانی از کدام ابزار استفاده کنید.